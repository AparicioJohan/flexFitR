---
title: "Predicted values"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Predicted values}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  warning = FALSE,
  message = FALSE
)
```

```{r setup}
library(flexFitR)
library(dplyr)
library(kableExtra)
library(ggpubr)
library(purrr)
```

```{r}
data(dt_potato)
head(dt_potato) |> kable()
```

## 0. Model fitting

```{r}
fn <- function(t, L, k, t0) L / (1 + exp(-k * (t - t0)))
```

```{r}
mod_1 <- dt_potato |>
  modeler(
    x = DAP,
    y = Canopy,
    grp = Plot,
    fn = "fn",
    parameters = c(L = 100, k = 4, t0 = 40),
    subset = c(166, 40)
  )
mod_1
```

```{r, fig.width= 8, fig.height=4, fig.alt="plot fit"}
plot(mod_1, id = c(166, 40))
```

## 1. Point prediction

```{r,  fig.alt="plot fit 2", fig.width= 8}
predict(mod_1, x = 45, type = "point") |> kable()
```

```{r,  fig.alt="plot fit 2", fig.width= 8}
plot(mod_1, id = c(166, 40), type = 3) + color_palette(palette = "jco")
```


## 2. Integral of the function (area under the curve)

```{r}
predict(mod_1, x = c(0, 108), type = "auc") |> kable()
```

## 3. Function of the parameters

```{r}
predict(mod_1, formula = ~ k / L * 100) |> kable()
```
```{r}
predict(mod_1, formula = ~ (k * L) / 4) |> kable()
```


## 4. Inflection points (first derivative)

```{r, fig.width= 8, fig.height=4, fig.alt="plot 1 deriv"}
plot(mod_1, id = c(166, 40), type = 5, color = "blue", add_ci = FALSE)
```

```{r}
interval <- seq(0, 100, by = 0.1)
points_fd <- mod_1 |>
  predict(x = interval, type = "fd") |>
  group_by(uid) |>
  summarise(x_max = x_new[which.max(predicted.value)])
points_fd |> kable()
```

## 5. Inflection points (second derivative)

```{r, fig.width= 8, fig.height=4, fig.alt="plot 2 deriv"}
plot(mod_1, id = c(166, 40), type = 6, color = "blue", add_ci = FALSE)
```

```{r}
points_sd <- mod_1 |>
  predict(x = interval, type = "sd") |>
  group_by(uid) |>
  summarise(
    x_max = x_new[which.max(predicted.value)],
    x_min = x_new[which.min(predicted.value)]
  )
points_sd |> kable()
```
